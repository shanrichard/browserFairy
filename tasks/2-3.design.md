# Design 2-3 - 功能完成度评估和后续规划

## Requirements

基于BrowserFairy当前75%的实现完成度，结合开发同事在实际使用中的需求反馈和技术专家评审意见，制定清晰的后续开发规划。

### 核心问题

开发同事在实际使用中发现的关键痛点：
1. **内存泄漏源头难定位**：知道内存在增长，但不知道具体是哪个组件或函数导致
2. **主线程阻塞无法追踪**：页面卡顿时无法确定是哪个JavaScript任务阻塞了>50ms
3. **WebSocket问题不可见**：发现WebSocket错误但看不到具体消息内容和频率
4. **内存分析工具缺失**：需要更细粒度的内存分配分析能力

### 技术专家评审结论

专家对四个需求的可行性分析：

**需求1 - 内存泄漏源头定位**
- 原提案中的DOM遍历方案性能开销过大
- 事件监听器分组统计可行，需使用`DOMDebugger.getEventListeners`
- MVP版本：针对核心对象采样，避免全量扫描

**需求2 - 长任务检测**  
- 技术路线调整：使用`PerformanceObserver('longtask')`注入方案
- `Performance.metrics`无法获取长任务详情，原方案不可行
- 调用栈获取有技术限制，先记录scriptURL和frame

**需求3 - WebSocket监控**
- 技术可行性高，`Network.webSocketFrameSent/Received`直接可用
- 需要数据截断和隐私保护措施
- 可基于现有NetworkMonitor快速扩展

**需求4 - 内存快照分析**
- 定期`takeHeapSnapshot`不现实，会严重影响性能  
- 替代方案：`HeapProfiler.startSampling`轻量采样
- 完整快照改为手动/阈值触发

## Solution

### 实施策略

按技术难度和用户价值分两个阶段实施：

#### 阶段1：立即实现（1-2周，基于现有架构扩展）
1. **WebSocket消息监控**：扩展NetworkMonitor，添加WebSocket帧事件处理  任务2-3-9
2. **事件监听器分组统计**：使用DOMDebugger.getEventListeners实现简化版  任务2-3-10

#### 阶段2：中期实现（3-6周，新技术方案）  
1. **长任务检测**：PerformanceObserver注入方案，需处理CSP等复杂性 任务2-3-11
2. **内存采样分析**：HeapProfiler采样替代完整快照  任务2-3-12

### 技术原则

1. **性能优先**：所有新功能都需要频率控制和数据截断
2. **原始数据导向**：专注数据收集，分析留给后续AI工具
3. **向下兼容**：不影响现有75%已完成功能的稳定性
4. **渐进实现**：每个阶段都有独立价值，避免大爆炸式开发

## Tests

各子任务将根据具体技术方案设计相应的测试策略。