# Design 1-3 - 标签页列表监控器

## Requirements
- 实时监控标签页的创建、关闭、URL变化（导航/SPA路由）
- 能识别标签页所属的网站域名（基础域名解析）
- 维护标签页状态的内存映射
- **明确不做**：标签页切换/激活事件（CDP无稳定支持，移至后续attach阶段）

## Solution

### 核心策略（引入Target会话管理）
基于专家建议，1-3是引入sessionId路由的关键节点：
- **事件监听**：使用`Target.setDiscoverTargets(true)`启用事件
- **会话管理**：引入sessionId映射，为1-4的性能数据收集做准备
- **策略兼容**：事件+低频轮询兜底（3-5s），确保数据完整性

### 最小收敛实现（基于专家建议修正）
1. **启用发现（关键前置步骤）**
   - 启动时调用`Target.setDiscoverTargets({"discover": true})`
   - 没有这步，后续事件监听完全无效

2. **扩展ChromeConnector支持事件**
   - 修改消息处理：区分responses（有id）和events（无id）
   - 实现事件回调机制：`on_event(method, params)`
   - 预留sessionId路由：为后续Target会话做准备

3. **TabMonitor类（轻量状态管理）**
   - 监听事件：`Target.targetCreated`、`Target.targetDestroyed`、`Target.targetInfoChanged`
   - 轮询兜底：每3-5秒`Target.getTargets()`，以轮询为准纠正抖动
   - 状态映射：`targetId -> {url, title, hostname, browserContextId}`
   - 过滤规则：排除chrome://、devtools://、about:等非站点URL

4. **基础域名解析（不过度设计）**
   - 使用`urlparse(url).hostname`提取域名
   - 不做eTLD+1分类（留给1-7）
   - hostname为空时忽略目标

5. **CLI实时监控**
   - `--monitor-tabs`：输出创建/关闭/URL变化
   - 不承诺标签页切换/激活状态

### 事件处理流程（修正后）
```
1. 启用发现 → Target.setDiscoverTargets({"discover": true})
2. 接收现有targets → 一系列Target.targetCreated事件（仅处理type='page'）
3. 实时监听 → targetCreated/targetDestroyed/targetInfoChanged
4. 过滤噪声 → 排除chrome://等非站点URL
5. 轮询兜底 → 3-5秒Target.getTargets()，以轮询快照为准
6. 状态一致 → 事件更新内存映射，轮询纠正抖动
```

### 事件去抖和一致性模型
- **最终一致**：以轮询快照为准，事件仅作实时更新
- **去重逻辑**：targetId作为唯一标识，URL/title变化触发update
- **抖动处理**：快速连续的同target事件，合并为单次状态变更

### 技术细节

**事件处理改进ChromeConnector**：
```python
# 消息处理逻辑
async def _handle_messages(self):
    async for message in self.websocket:
        data = json.loads(message)
        
        if "id" in data:  # Response
            # 现有的response处理逻辑
        else:  # Event  
            method = data.get("method")
            params = data.get("params", {})
            await self._dispatch_event(method, params)
```

**基础域名解析函数（不过度设计）**：
- 使用`urllib.parse.urlparse(url).hostname`
- 过滤规则：排除chrome://、devtools://、about:、chrome-extension://等
- hostname为空时忽略该target
- 不做eTLD+1、主站/三方分类（留给1-7）

**预留sessionId路由**：
```python
async def call(self, method, params=None, session_id=None):
    message = {"id": request_id, "method": method}
    if params: message["params"] = params  
    if session_id: message["sessionId"] = session_id
```

## Tests

### 单元测试
1. **ChromeConnector事件处理**
   - `test_event_dispatch()` - 验证事件分发机制
   - `test_response_vs_event()` - 区分响应和事件
   - `test_session_id_routing()` - sessionId路由预留

2. **TabMonitor核心功能**  
   - `test_discover_targets_enable()` - 验证发现启用
   - `test_target_events_handling()` - 处理创建/销毁事件
   - `test_domain_extraction()` - URL→domain解析

### 集成测试（需要Chrome实例）
1. **事件监听验证**
   - `test_tab_creation_event()` - 新建标签页事件捕获
   - `test_tab_destruction_event()` - 关闭标签页事件捕获
   - `test_fallback_polling()` - 轮询兜底机制

2. **实时监控测试**
   - `test_monitor_tabs_command()` - CLI监控命令
   - `test_graceful_shutdown()` - Ctrl+C优雅退出
   - `test_domain_classification()` - 域名分类准确性

### 边界情况
- Chrome启动时已有多个标签页
- 快速连续创建/关闭标签页
- 标签页导航但不换domain
- 特殊URL（chrome://、devtools://）

### 验收测试
```bash
# 实时监控标签页（修正后的输出）
python -m browserfairy --monitor-tabs

# 输出示例：
# [2024-08-14 14:30:15] CREATED: google.com - Google (ABC123)
# [2024-08-14 14:30:18] URL_CHANGED: github.com - GitHub Issues (DEF456) 
# [2024-08-14 14:30:22] DESTROYED: github.com - GitHub Issues (DEF456)
# [2024-08-14 14:30:28] CREATED: news.example.com - Breaking News (GHI789)
# ^C Monitoring stopped.
```

**关键修正点**：
- ✅ 必须先调用`Target.setDiscoverTargets`启用事件
- ✅ 监听`Target.targetInfoChanged`捕获URL变化
- ✅ 过滤chrome://等噪声目标  
- ✅ 以轮询快照为准，事件作实时更新
- ✅ 不承诺标签页切换/激活检测
- ✅ 基础域名解析，不过度设计分类