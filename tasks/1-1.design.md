# Design 1-1 - 项目基础设施和CDP基本连接

## Requirements
- 搭建Python项目基础设施，配置依赖管理
- 实现Chrome DevTools Protocol的基本WebSocket连接
- 能连接到Chrome并发送简单的CDP命令
- 验证连接是否成功，获取Chrome版本信息

## Solution

### 技术栈选择
- **依赖管理**: uv（已配置）
- **核心库**: websockets（现代异步WebSocket客户端）+ asyncio + pathlib
- **HTTP请求**: httpx（获取Chrome的WebSocket端点）

### 项目结构
```
browserfairy/
├── __init__.py
├── __main__.py         # python -m browserfairy 入口
├── core/
│   ├── __init__.py
│   └── connector.py     # Chrome连接器
├── utils/
│   ├── __init__.py
│   └── paths.py         # 跨平台路径工具
└── cli.py              # CLI逻辑实现
```

### 核心实现
1. **ChromeConnector类（Browser级会话，向前兼容设计）**
   - **服务发现**：每次连接前GET `http://host:port/json/version`（2-3s超时）
   - **端点验证**：校验返回JSON包含`Browser`和`webSocketDebuggerUrl`字段
   - **WebSocket连接**：使用提取的URL建立连接（3-5s超时）
   - **RPC接口**：`call(method, params=None, session_id=None)`，1-1阶段session_id固定为None
   - **响应管理**：id→future映射，RPC响应超时3-5s
   - **消息处理**：简单的request-response模式，忽略事件消息

2. **跨平台路径处理**
   - 使用`pathlib.Path.home()`获取用户主目录
   - 支持环境变量`BROWSERFAIRY_DATA_DIR`覆盖默认路径
   - 仅确保目录存在和可写，不做复杂权限检查

3. **三类错误处理**
   - **端口未开放/拒绝连接**：提示使用chrome-debug脚本启动Chrome
   - **端口被占用**：提示更换端口或关闭占用进程
   - **连接到非Chrome服务**：校验`/json/version`响应结构

4. **配置支持**
   - CLI参数：`--host`（默认127.0.0.1）、`--port`（默认9222）
   - 环境变量：`CHROME_DEBUG_HOST`、`CHROME_DEBUG_PORT`

5. **重连机制**
   - 3次重试，每次重试前重新获取`webSocketDebuggerUrl`
   - 指数退避：1s、2s、4s

### CLI验证命令
```bash
python -m browserfairy --test-connection [--host HOST] [--port PORT]
# 输出Chrome版本信息和连接状态
# 失败时提供具体的错误类型和解决建议
```

### 依赖配置更新
```toml
# pyproject.toml 需要添加：
[project]
requires-python = ">=3.11"  # 放宽版本要求
dependencies = [
    "websockets>=12.0",
    "httpx>=0.25.0"
]
```

## Tests

### 单元测试（使用pytest + pytest-asyncio）
1. **路径工具测试（使用临时目录）**
   - `test_get_data_directory_with_env_override()` - 验证环境变量覆盖
   - `test_directory_creation()` - 验证目录创建（不污染用户目录）

2. **连接器基础测试**
   - `test_format_browser_command()` - 验证Browser.getVersion消息格式
   - `test_request_id_increment()` - 验证ID递增逻辑
   - `test_validate_chrome_response()` - 验证/json/version响应结构校验

### 集成测试（需要Chrome实例）
1. **连接测试**
   - `test_browser_get_version()` - 连接真实Chrome并调用Browser.getVersion
   - `test_websocket_timeout()` - 验证WebSocket和RPC超时设置

2. **三类错误场景测试**
   - `test_port_connection_refused()` - 端口拒绝连接的错误提示
   - `test_non_chrome_service()` - 连接到非Chrome服务的校验
   - `test_endpoint_refresh_on_retry()` - 重试时重新获取WebSocket端点

### 验收测试
- `python -m browserfairy --test-connection`成功显示Chrome版本和Browser字段
- `python -m browserfairy --test-connection --port 9223`支持自定义端口
- Chrome未启动时显示"请使用chrome-debug脚本启动Chrome"提示
- 在配置的数据目录创建基础结构（默认~/BrowserFairyData）